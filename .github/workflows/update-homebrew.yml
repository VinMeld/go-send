name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: VinMeld/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Get release information
        id: release
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT

      - name: Download release assets and calculate SHA256
        id: sha256
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          TAG="${{ steps.release.outputs.tag }}"
          
          # Download all platform archives
          wget -q "https://github.com/VinMeld/go-send/releases/download/${TAG}/go-send_${VERSION}_darwin_arm64.tar.gz"
          wget -q "https://github.com/VinMeld/go-send/releases/download/${TAG}/go-send_${VERSION}_darwin_amd64.tar.gz"
          wget -q "https://github.com/VinMeld/go-send/releases/download/${TAG}/go-send_${VERSION}_linux_arm64.tar.gz"
          wget -q "https://github.com/VinMeld/go-send/releases/download/${TAG}/go-send_${VERSION}_linux_amd64.tar.gz"
          
          # Calculate SHA256 hashes
          DARWIN_ARM64_SHA=$(shasum -a 256 "go-send_${VERSION}_darwin_arm64.tar.gz" | awk '{print $1}')
          DARWIN_AMD64_SHA=$(shasum -a 256 "go-send_${VERSION}_darwin_amd64.tar.gz" | awk '{print $1}')
          LINUX_ARM64_SHA=$(shasum -a 256 "go-send_${VERSION}_linux_arm64.tar.gz" | awk '{print $1}')
          LINUX_AMD64_SHA=$(shasum -a 256 "go-send_${VERSION}_linux_amd64.tar.gz" | awk '{print $1}')
          
          echo "darwin_arm64_sha=$DARWIN_ARM64_SHA" >> $GITHUB_OUTPUT
          echo "darwin_amd64_sha=$DARWIN_AMD64_SHA" >> $GITHUB_OUTPUT
          echo "linux_arm64_sha=$LINUX_ARM64_SHA" >> $GITHUB_OUTPUT
          echo "linux_amd64_sha=$LINUX_AMD64_SHA" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          VERSION="${{ steps.release.outputs.version }}"
          
          cat > homebrew-tap/Formula/go-send.rb << 'EOF'
          class GoSend < Formula
            desc "Secure, end-to-end encrypted file sharing with store-and-forward"
            homepage "https://github.com/VinMeld/go-send"
            version "${{ steps.release.outputs.version }}"
            license "GPL-3.0"

            on_macos do
              on_arm do
                url "https://github.com/VinMeld/go-send/releases/download/${{ steps.release.outputs.tag }}/go-send_${{ steps.release.outputs.version }}_darwin_arm64.tar.gz"
                sha256 "${{ steps.sha256.outputs.darwin_arm64_sha }}"
              end
              on_intel do
                url "https://github.com/VinMeld/go-send/releases/download/${{ steps.release.outputs.tag }}/go-send_${{ steps.release.outputs.version }}_darwin_amd64.tar.gz"
                sha256 "${{ steps.sha256.outputs.darwin_amd64_sha }}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/VinMeld/go-send/releases/download/${{ steps.release.outputs.tag }}/go-send_${{ steps.release.outputs.version }}_linux_arm64.tar.gz"
                sha256 "${{ steps.sha256.outputs.linux_arm64_sha }}"
              end
              on_intel do
                url "https://github.com/VinMeld/go-send/releases/download/${{ steps.release.outputs.tag }}/go-send_${{ steps.release.outputs.version }}_linux_amd64.tar.gz"
                sha256 "${{ steps.sha256.outputs.linux_amd64_sha }}"
              end
            end

            def install
              bin.install "go-send"
            end

            test do
              assert_match "go-send", shell_output("#{bin}/go-send --help 2>&1")
            end

            def caveats
              <<~EOS
                To get started with go-send:
                  1. Initialize: go-send config init --user <username>
                  2. Set server: go-send set-server <server-url>
                  3. Register: go-send register --token <token>
                  
                Documentation: https://github.com/VinMeld/go-send
              EOS
            end
          end
          EOF

      - name: Commit and push changes
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/go-send.rb
          git commit -m "Update go-send to ${{ steps.release.outputs.version }}"
          git push
